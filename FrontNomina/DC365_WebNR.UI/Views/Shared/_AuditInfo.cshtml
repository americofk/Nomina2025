@using DC365_WebNR.CORE.Domain.Models.Common
@model AuditableModel

@*
    Partial View para mostrar información de auditoría ISO 27001
    Uso: Este componente se renderiza con JavaScript leyendo los campos hidden del formulario
*@

<div id="audit-info-container-dynamic" class="audit-info-container" style="display: none;"></div>

<script>
    // Este script se ejecuta cuando los campos del formulario son llenados
    document.addEventListener('DOMContentLoaded', function() {
        updateAuditInfo();
    });

    // Función para actualizar la información de auditoría
    function updateAuditInfo() {
        const recId = parseInt(document.getElementById('RecId')?.value || '0');
        const dataAreaId = document.getElementById('DataAreaId')?.value || '';
        const createdBy = document.getElementById('CreatedBy')?.value || '';
        const createdOn = document.getElementById('CreatedOn')?.value || '';
        const modifiedBy = document.getElementById('ModifiedBy')?.value || '';
        const modifiedOn = document.getElementById('ModifiedOn')?.value || '';
        const isDeleted = document.getElementById('IsDeleted')?.value === 'true';
        const deletedBy = document.getElementById('DeletedBy')?.value || '';
        const deletedOn = document.getElementById('DeletedOn')?.value || '';

        const container = document.getElementById('audit-info-container-dynamic');
        const auditSection = document.getElementById('audit-info-section');

        if (!container) return;

        // Solo mostrar si RecId > 0
        if (recId > 0) {
            container.style.display = 'block';

            // Mostrar la sección de auditoría
            if (auditSection) {
                auditSection.style.display = 'block';
            }

            let html = `
                <div style="display: flex; gap: 15px;">
                    <div class="contlotes" style="flex: 1;">
                        <label class="control-label ancholabel">Creado por</label>
                        <div class="anchoimput">
                            <input type="text" class="form-control" value="${createdBy || 'N/A'}" readonly />
                        </div>
                    </div>
                    <div class="contlotes" style="flex: 1;">
                        <label class="control-label ancholabel">Fecha de creación</label>
                        <div class="anchoimput">
                            <input type="text" class="form-control" value="${formatDate(createdOn)}" readonly />
                        </div>
                    </div>
                    <div class="contlotes" style="flex: 1;">
                        <label class="control-label ancholabel">Empresa</label>
                        <div class="anchoimput">
                            <input type="text" class="form-control" value="${dataAreaId || 'N/A'}" readonly />
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 15px;">
                    <div class="contlotes" style="flex: 1;">
                        <label class="control-label ancholabel">Modificado por</label>
                        <div class="anchoimput">
                            <input type="text" class="form-control" value="${modifiedBy || 'N/A'}" readonly />
                        </div>
                    </div>
                    <div class="contlotes" style="flex: 1;">
                        <label class="control-label ancholabel">Última modificación</label>
                        <div class="anchoimput">
                            <input type="text" class="form-control" value="${formatDate(modifiedOn)}" readonly />
                        </div>
                    </div>
                    <div class="contlotes" style="flex: 1;">
                        <label class="control-label ancholabel">RecId</label>
                        <div class="anchoimput">
                            <input type="text" class="form-control" value="${recId}" readonly />
                        </div>
                    </div>
                </div>`;

            if (isDeleted) {
                html += `
                <div style="display: flex; gap: 15px;">
                    <div class="contlotes" style="flex: 1;">
                        <label class="control-label ancholabel" style="color: #d9534f;">Eliminado por</label>
                        <div class="anchoimput">
                            <input type="text" class="form-control" value="${deletedBy || 'N/A'}" readonly style="background-color: #f2dede; border-color: #ebccd1;" />
                        </div>
                    </div>
                    <div class="contlotes" style="flex: 1;">
                        <label class="control-label ancholabel" style="color: #d9534f;">Fecha de eliminación</label>
                        <div class="anchoimput">
                            <input type="text" class="form-control" value="${formatDate(deletedOn)}" readonly style="background-color: #f2dede; border-color: #ebccd1;" />
                        </div>
                    </div>
                    <div class="contlotes" style="flex: 1;">
                    </div>
                </div>`;
            }

            container.innerHTML = html;
        } else {
            container.style.display = 'none';

            // Ocultar la sección de auditoría cuando es nuevo registro
            if (auditSection) {
                auditSection.style.display = 'none';
            }
        }
    }

    // Funcionalidad para colapsar/expandir el panel de auditoría
    document.addEventListener('DOMContentLoaded', function() {
        const panelHeader = document.getElementById('audit-panel-header');
        const panelContent = document.getElementById('audit-panel-content');
        const chevron = document.getElementById('audit-chevron');

        if (panelHeader && panelContent && chevron) {
            panelHeader.addEventListener('click', function() {
                if (panelContent.style.display === 'none') {
                    panelContent.style.display = 'block';
                    chevron.classList.remove('fa-chevron-right');
                    chevron.classList.add('fa-chevron-down');
                } else {
                    panelContent.style.display = 'none';
                    chevron.classList.remove('fa-chevron-down');
                    chevron.classList.add('fa-chevron-right');
                }
            });
        }
    });

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'N/A';

            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');

            return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
        } catch {
            return 'N/A';
        }
    }

    // Exponer la función globalmente para que pueda ser llamada después de cargar datos con AJAX
    window.updateAuditInfo = updateAuditInfo;
</script>

@if (false)
{
    <div class="audit-info-container">
        <div class="x_panel audit-panel">
            <div class="x_title audit-title">
                <h4>
                    <i class="fa fa-info-circle"></i> Información del Registro
                </h4>
                <div class="clearfix"></div>
            </div>
            <div class="x_content audit-content">
                <div class="audit-info-grid">

                    @* Columna 1: Información de Creación *@
                    <div class="audit-section">
                        <div class="audit-item">
                            <label class="audit-label">
                                <i class="fa fa-user-plus"></i> Creado por:
                            </label>
                            <span class="audit-value">@(Model.CreatedBy ?? "N/A")</span>
                        </div>
                        <div class="audit-item">
                            <label class="audit-label">
                                <i class="fa fa-calendar"></i> Fecha de creación:
                            </label>
                            <span class="audit-value">
                                @if (Model.CreatedOn != DateTime.MinValue)
                                {
                                    @Model.CreatedOn.ToString("dd/MM/yyyy HH:mm:ss")
                                }
                                else
                                {
                                    <text>N/A</text>
                                }
                            </span>
                        </div>
                    </div>

                    @* Columna 2: Información de Modificación *@
                    <div class="audit-section">
                        <div class="audit-item">
                            <label class="audit-label">
                                <i class="fa fa-user-circle"></i> Modificado por:
                            </label>
                            <span class="audit-value">@(Model.ModifiedBy ?? "N/A")</span>
                        </div>
                        <div class="audit-item">
                            <label class="audit-label">
                                <i class="fa fa-calendar-check-o"></i> Última modificación:
                            </label>
                            <span class="audit-value">
                                @if (Model.ModifiedOn != DateTime.MinValue)
                                {
                                    @Model.ModifiedOn.ToString("dd/MM/yyyy HH:mm:ss")
                                }
                                else
                                {
                                    <text>N/A</text>
                                }
                            </span>
                        </div>
                    </div>

                    @* Columna 3: Información de Empresa (si es AuditableCompanyModel) *@
                    @if (Model is AuditableCompanyModel companyModel)
                    {
                        <div class="audit-section">
                            <div class="audit-item">
                                <label class="audit-label">
                                    <i class="fa fa-building"></i> Empresa:
                                </label>
                                <span class="audit-value">@(companyModel.DataAreaId ?? "N/A")</span>
                            </div>
                            <div class="audit-item">
                                <label class="audit-label">
                                    <i class="fa fa-hashtag"></i> RecId:
                                </label>
                                <span class="audit-value">@Model.RecId</span>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="audit-section">
                            <div class="audit-item">
                                <label class="audit-label">
                                    <i class="fa fa-hashtag"></i> RecId:
                                </label>
                                <span class="audit-value">@Model.RecId</span>
                            </div>
                        </div>
                    }

                    @* Información de Eliminación (si está eliminado) *@
                    @if (Model.IsDeleted)
                    {
                        <div class="audit-section audit-deleted">
                            <div class="audit-item">
                                <label class="audit-label">
                                    <i class="fa fa-user-times"></i> Eliminado por:
                                </label>
                                <span class="audit-value deleted-by">@(Model.DeletedBy ?? "N/A")</span>
                            </div>
                            <div class="audit-item">
                                <label class="audit-label">
                                    <i class="fa fa-calendar-times-o"></i> Fecha de eliminación:
                                </label>
                                <span class="audit-value deleted-date">
                                    @if (Model.DeletedOn.HasValue)
                                    {
                                        @Model.DeletedOn.Value.ToString("dd/MM/yyyy HH:mm:ss")
                                    }
                                    else
                                    {
                                        <text>N/A</text>
                                    }
                                </span>
                            </div>
                        </div>
                    }

                </div>
            </div>
        </div>
    </div>
}

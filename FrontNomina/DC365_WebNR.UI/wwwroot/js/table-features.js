/**
 * @file table-features.ts
 * @description Funcionalidades de tabla: filtro en todas las columnas y ordenamiento.
 * @author Equipo de Desarrollo
 * @date 2025
 */
/**
 * Inicializa el filtro que busca en todas las columnas de la tabla.
 * @param inputSelector Selector del input de búsqueda
 * @param tableSelector Selector de la tabla
 * @param tbodySelector Selector del tbody
 */
function initTableFilter(inputSelector, tableSelector, tbodySelector) {
    var _a;
    // Buscar el input - puede ser un selector múltiple separado por comas
    let input = null;
    const selectors = inputSelector.split(',').map(s => s.trim());
    for (const selector of selectors) {
        input = document.querySelector(selector);
        if (input)
            break;
    }
    if (!input)
        return;
    // Remover listener previo si existe (para evitar duplicados)
    const newInput = input.cloneNode(true);
    (_a = input.parentNode) === null || _a === void 0 ? void 0 : _a.replaceChild(newInput, input);
    input = newInput;
    input.addEventListener('keyup', function () {
        const searchText = this.value.toLowerCase().trim();
        const rows = document.querySelectorAll(`${tbodySelector} tr.row-app`);
        rows.forEach((row) => {
            // Buscar en TODAS las celdas (excepto checkbox)
            const cells = row.querySelectorAll('td:not(.check-cell-app)');
            let found = false;
            // Si no hay texto de búsqueda, mostrar todas las filas
            if (searchText === '') {
                found = true;
            }
            else {
                cells.forEach((cell) => {
                    const cellText = (cell.textContent || '').toLowerCase();
                    if (cellText.includes(searchText)) {
                        found = true;
                    }
                });
            }
            row.style.display = found ? '' : 'none';
        });
    });
    // También ejecutar en el evento 'input' para mayor responsividad
    input.addEventListener('input', function () {
        const event = new Event('keyup');
        this.dispatchEvent(event);
    });
}
/**
 * Estado del ordenamiento por tabla
 */
const sortState = new Map();
/**
 * Inicializa el ordenamiento de columnas al hacer clic en los headers.
 * @param tableSelector Selector de la tabla
 */
function initTableSort(tableSelector) {
    const table = document.querySelector(tableSelector);
    if (!table)
        return;
    const headerRow = table.querySelector('thead tr');
    if (!headerRow)
        return;
    const headers = headerRow.querySelectorAll('td:not(.check-cell-app)');
    headers.forEach((header, index) => {
        const th = header;
        // Agregar estilos de cursor y icono
        th.style.cursor = 'pointer';
        th.style.userSelect = 'none';
        th.style.position = 'relative';
        // Agregar icono de ordenamiento
        if (!th.querySelector('.sort-icon')) {
            const icon = document.createElement('i');
            icon.className = 'fa fa-sort sort-icon';
            icon.style.marginLeft = '5px';
            icon.style.opacity = '0.5';
            icon.style.fontSize = '12px';
            th.appendChild(icon);
        }
        th.addEventListener('click', () => {
            sortTable(tableSelector, index, th);
        });
    });
}
/**
 * Ordena la tabla por la columna especificada.
 */
function sortTable(tableSelector, columnIndex, headerCell) {
    const table = document.querySelector(tableSelector);
    if (!table)
        return;
    const tbody = table.querySelector('tbody');
    if (!tbody)
        return;
    // Obtener estado actual
    const currentState = sortState.get(tableSelector);
    let direction = 'asc';
    if (currentState && currentState.column === columnIndex) {
        direction = currentState.direction === 'asc' ? 'desc' : 'asc';
    }
    // Guardar nuevo estado
    sortState.set(tableSelector, { column: columnIndex, direction });
    // Actualizar iconos de todos los headers
    const allHeaders = table.querySelectorAll('thead td:not(.check-cell-app)');
    allHeaders.forEach((h) => {
        const icon = h.querySelector('.sort-icon');
        if (icon) {
            icon.className = 'fa fa-sort sort-icon';
            icon.style.opacity = '0.5';
        }
    });
    // Actualizar icono del header actual
    const currentIcon = headerCell.querySelector('.sort-icon');
    if (currentIcon) {
        currentIcon.className = direction === 'asc' ? 'fa fa-sort-asc sort-icon' : 'fa fa-sort-desc sort-icon';
        currentIcon.style.opacity = '1';
    }
    // Obtener filas y ordenar
    const rows = Array.from(tbody.querySelectorAll('tr.row-app'));
    rows.sort((a, b) => {
        // +1 porque la primera celda es el checkbox
        const cellA = a.querySelectorAll('td')[columnIndex + 1];
        const cellB = b.querySelectorAll('td')[columnIndex + 1];
        if (!cellA || !cellB)
            return 0;
        let valueA = (cellA.textContent || '').trim();
        let valueB = (cellB.textContent || '').trim();
        // Intentar comparar como números
        const numA = parseFloat(valueA.replace(/[^0-9.-]/g, ''));
        const numB = parseFloat(valueB.replace(/[^0-9.-]/g, ''));
        if (!isNaN(numA) && !isNaN(numB)) {
            return direction === 'asc' ? numA - numB : numB - numA;
        }
        // Intentar comparar como fechas (formato dd/mm/yyyy o similar)
        const dateA = parseDate(valueA);
        const dateB = parseDate(valueB);
        if (dateA && dateB) {
            return direction === 'asc'
                ? dateA.getTime() - dateB.getTime()
                : dateB.getTime() - dateA.getTime();
        }
        // Comparar como texto
        valueA = valueA.toLowerCase();
        valueB = valueB.toLowerCase();
        if (direction === 'asc') {
            return valueA.localeCompare(valueB, 'es');
        }
        else {
            return valueB.localeCompare(valueA, 'es');
        }
    });
    // Reinsertar filas ordenadas
    rows.forEach((row) => tbody.appendChild(row));
}
/**
 * Intenta parsear una fecha en varios formatos comunes.
 */
function parseDate(dateStr) {
    if (!dateStr)
        return null;
    // Formato dd/mm/yyyy
    const parts1 = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if (parts1) {
        return new Date(parseInt(parts1[3]), parseInt(parts1[2]) - 1, parseInt(parts1[1]));
    }
    // Formato mm/dd/yyyy
    const parts2 = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if (parts2) {
        const date = new Date(parseInt(parts2[3]), parseInt(parts2[1]) - 1, parseInt(parts2[2]));
        if (!isNaN(date.getTime()))
            return date;
    }
    // Formato yyyy-mm-dd
    const parts3 = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (parts3) {
        return new Date(parseInt(parts3[1]), parseInt(parts3[2]) - 1, parseInt(parts3[3]));
    }
    return null;
}
/**
 * Inicializa todas las funcionalidades de tabla.
 * @param config Configuración de la tabla o selector de la tabla
 */
function initTableFeatures(config) {
    // Si es un string, crear configuración automática
    let tableSelector;
    let filterInputSelector;
    let tbodySelector;
    if (typeof config === 'string') {
        tableSelector = config;
        // Buscar el input de filtro más común (ViewFilter.cshtml usa .textFilterMask)
        filterInputSelector = '.textFilterMask, .form-control-text-filtre, .form-control-filtro, .form-control-FiltroDepartment, input[placeholder*="Buscar"], input[placeholder*="columnas"]';
        tbodySelector = `${config} tbody`;
    }
    else {
        tableSelector = config.table;
        filterInputSelector = config.filterInput;
        tbodySelector = config.tbody;
    }
    const doInit = () => {
        initTableFilter(filterInputSelector, tableSelector, tbodySelector);
        initTableSort(tableSelector);
    };
    // Esperar a que el DOM esté listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', doInit);
    }
    else {
        doInit();
    }
}
// Exportar al ámbito global
window.initTableFeatures = initTableFeatures;
window.initTableFilter = initTableFilter;
window.initTableSort = initTableSort;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFibGUtZmVhdHVyZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9UeXBlU2NyaXB0RmlsZS90YWJsZS1mZWF0dXJlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7R0FLRztBQUVIOzs7OztHQUtHO0FBQ0gsU0FBUyxlQUFlLENBQUMsYUFBcUIsRUFBRSxhQUFxQixFQUFFLGFBQXFCOztJQUN4RixzRUFBc0U7SUFDdEUsSUFBSSxLQUFLLEdBQTRCLElBQUksQ0FBQztJQUMxQyxNQUFNLFNBQVMsR0FBRyxhQUFhLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBRTlELEtBQUssTUFBTSxRQUFRLElBQUksU0FBUyxFQUFFLENBQUM7UUFDL0IsS0FBSyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFxQixDQUFDO1FBQzdELElBQUksS0FBSztZQUFFLE1BQU07SUFDckIsQ0FBQztJQUVELElBQUksQ0FBQyxLQUFLO1FBQUUsT0FBTztJQUVuQiw2REFBNkQ7SUFDN0QsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQXFCLENBQUM7SUFDM0QsTUFBQSxLQUFLLENBQUMsVUFBVSwwQ0FBRSxZQUFZLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ2hELEtBQUssR0FBRyxRQUFRLENBQUM7SUFFakIsS0FBSyxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRTtRQUM1QixNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ25ELE1BQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLGFBQWEsYUFBYSxDQUFDLENBQUM7UUFFdEUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFD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aUJBQWlCLEdBQUcsaUJBQWlCLENBQUM7QUFDckQsTUFBYyxDQUFDLGVBQWUsR0FBRyxlQUFlLENBQUM7QUFDakQsTUFBYyxDQUFDLGFBQWEsR0FBRyxhQUFhLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogQGZpbGUgdGFibGUtZmVhdHVyZXMudHNcclxuICogQGRlc2NyaXB0aW9uIEZ1bmNpb25hbGlkYWRlcyBkZSB0YWJsYTogZmlsdHJvIGVuIHRvZGFzIGxhcyBjb2x1bW5hcyB5IG9yZGVuYW1pZW50by5cclxuICogQGF1dGhvciBFcXVpcG8gZGUgRGVzYXJyb2xsb1xyXG4gKiBAZGF0ZSAyMDI1XHJcbiAqL1xyXG5cclxuLyoqXHJcbiAqIEluaWNpYWxpemEgZWwgZmlsdHJvIHF1ZSBidXNjYSBlbiB0b2RhcyBsYXMgY29sdW1uYXMgZGUgbGEgdGFibGEuXHJcbiAqIEBwYXJhbSBpbnB1dFNlbGVjdG9yIFNlbGVjdG9yIGRlbCBpbnB1dCBkZSBiw7pzcXVlZGFcclxuICogQHBhcmFtIHRhYmxlU2VsZWN0b3IgU2VsZWN0b3IgZGUgbGEgdGFibGFcclxuICogQHBhcmFtIHRib2R5U2VsZWN0b3IgU2VsZWN0b3IgZGVsIHRib2R5XHJcbiAqL1xyXG5mdW5jdGlvbiBpbml0VGFibGVGaWx0ZXIoaW5wdXRTZWxlY3Rvcjogc3RyaW5nLCB0YWJsZVNlbGVjdG9yOiBzdHJpbmcsIHRib2R5U2VsZWN0b3I6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgLy8gQnVzY2FyIGVsIGlucHV0IC0gcHVlZGUgc2VyIHVuIHNlbGVjdG9yIG3Dumx0aXBsZSBzZXBhcmFkbyBwb3IgY29tYXNcclxuICAgIGxldCBpbnB1dDogSFRNTElucHV0RWxlbWVudCB8IG51bGwgPSBudWxsO1xyXG4gICAgY29uc3Qgc2VsZWN0b3JzID0gaW5wdXRTZWxlY3Rvci5zcGxpdCgnLCcpLm1hcChzID0+IHMudHJpbSgpKTtcclxuXHJcbiAgICBmb3IgKGNvbnN0IHNlbGVjdG9yIG9mIHNlbGVjdG9ycykge1xyXG4gICAgICAgIGlucHV0ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzZWxlY3RvcikgYXMgSFRNTElucHV0RWxlbWVudDtcclxuICAgICAgICBpZiAoaW5wdXQpIGJyZWFrO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghaW5wdXQpIHJldHVybjtcclxuXHJcbiAgICAvLyBSZW1vdmVyIGxpc3RlbmVyIHByZXZpbyBzaSBleGlzdGUgKHBhcmEgZXZpdGFyIGR1cGxpY2Fkb3MpXHJcbiAgICBjb25zdCBuZXdJbnB1dCA9IGlucHV0LmNsb25lTm9kZSh0cnVlKSBhcyBIVE1MSW5wdXRFbGVtZW50O1xyXG4gICAgaW5wdXQucGFyZW50Tm9kZT8ucmVwbGFjZUNoaWxkKG5ld0lucHV0LCBpbnB1dCk7XHJcbiAgICBpbnB1dCA9IG5ld0lucHV0O1xyXG5cclxuICAgIGlucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2tleXVwJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGNvbnN0IHNlYXJjaFRleHQgPSB0aGlzLnZhbHVlLnRvTG93ZXJDYXNlKCkudHJpbSgpO1xyXG4gICAgICAgIGNvbnN0IHJvd3MgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKGAke3Rib2R5U2VsZWN0b3J9IHRyLnJvdy1hcHBgKTtcclxuXHJcbiAgICAgICAgcm93cy5mb3JFYWNoKChyb3cpID0+IHtcclxuICAgICAgICAgICAgLy8gQnVzY2FyIGVuIFRPREFTIGxhcyBjZWxkYXMgKGV4Y2VwdG8gY2hlY2tib3gpXHJcbiAgICAgICAgICAgIGNvbnN0IGNlbGxzID0gcm93LnF1ZXJ5U2VsZWN0b3JBbGwoJ3RkOm5vdCguY2hlY2stY2VsbC1hcHApJyk7XHJcbiAgICAgICAgICAgIGxldCBmb3VuZCA9IGZhbHNlO1xyXG5cclxuICAgICAgICAgICAgLy8gU2kgbm8gaGF5IHRleHRvIGRlIGLDunNxdWVkYSwgbW9zdHJhciB0b2RhcyBsYXMgZmlsYXNcclxuICAgICAgICAgICAgaWYgKHNlYXJjaFRleHQgPT09ICcnKSB7XHJcbiAgICAgICAgICAgICAgICBmb3VuZCA9IHRydWU7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjZWxscy5mb3JFYWNoKChjZWxsKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2VsbFRleHQgPSAoY2VsbC50ZXh0Q29udGVudCB8fCAnJykudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoY2VsbFRleHQuaW5jbHVkZXMoc2VhcmNoVGV4dCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm91bmQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAocm93IGFzIEhUTUxFbGVtZW50KS5zdHlsZS5kaXNwbGF5ID0gZm91bmQgPyAnJyA6ICdub25lJztcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIFRhbWJpw6luIGVqZWN1dGFyIGVuIGVsIGV2ZW50byAnaW5wdXQnIHBhcmEgbWF5b3IgcmVzcG9uc2l2aWRhZFxyXG4gICAgaW5wdXQuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgY29uc3QgZXZlbnQgPSBuZXcgRXZlbnQoJ2tleXVwJyk7XHJcbiAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KGV2ZW50KTtcclxuICAgIH0pO1xyXG59XHJcblxyXG4vKipcclxuICogRXN0YWRvIGRlbCBvcmRlbmFtaWVudG8gcG9yIHRhYmxhXHJcbiAqL1xyXG5jb25zdCBzb3J0U3RhdGU6IE1hcDxzdHJpbmcsIHsgY29sdW1uOiBudW1iZXI7IGRpcmVjdGlvbjogJ2FzYycgfCAnZGVzYycgfT4gPSBuZXcgTWFwKCk7XHJcblxyXG4vKipcclxuICogSW5pY2lhbGl6YSBlbCBvcmRlbmFtaWVudG8gZGUgY29sdW1uYXMgYWwgaGFjZXIgY2xpYyBlbiBsb3MgaGVhZGVycy5cclxuICogQHBhcmFtIHRhYmxlU2VsZWN0b3IgU2VsZWN0b3IgZGUgbGEgdGFibGFcclxuICovXHJcbmZ1bmN0aW9uIGluaXRUYWJsZVNvcnQodGFibGVTZWxlY3Rvcjogc3RyaW5nKTogdm9pZCB7XHJcbiAgICBjb25zdCB0YWJsZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IodGFibGVTZWxlY3RvcikgYXMgSFRNTFRhYmxlRWxlbWVudDtcclxuICAgIGlmICghdGFibGUpIHJldHVybjtcclxuXHJcbiAgICBjb25zdCBoZWFkZXJSb3cgPSB0YWJsZS5xdWVyeVNlbGVjdG9yKCd0aGVhZCB0cicpO1xyXG4gICAgaWYgKCFoZWFkZXJSb3cpIHJldHVybjtcclxuXHJcbiAgICBjb25zdCBoZWFkZXJzID0gaGVhZGVyUm93LnF1ZXJ5U2VsZWN0b3JBbGwoJ3RkOm5vdCguY2hlY2stY2VsbC1hcHApJyk7XHJcblxyXG4gICAgaGVhZGVycy5mb3JFYWNoKChoZWFkZXIsIGluZGV4KSA9PiB7XHJcbiAgICAgICAgY29uc3QgdGggPSBoZWFkZXIgYXMgSFRNTEVsZW1lbnQ7XHJcblxyXG4gICAgICAgIC8vIEFncmVnYXIgZXN0aWxvcyBkZSBjdXJzb3IgeSBpY29ub1xyXG4gICAgICAgIHRoLnN0eWxlLmN1cnNvciA9ICdwb2ludGVyJztcclxuICAgICAgICB0aC5zdHlsZS51c2VyU2VsZWN0ID0gJ25vbmUnO1xyXG4gICAgICAgIHRoLnN0eWxlLnBvc2l0aW9uID0gJ3JlbGF0aXZlJztcclxuXHJcbiAgICAgICAgLy8gQWdyZWdhciBpY29ubyBkZSBvcmRlbmFtaWVudG9cclxuICAgICAgICBpZiAoIXRoLnF1ZXJ5U2VsZWN0b3IoJy5zb3J0LWljb24nKSkge1xyXG4gICAgICAgICAgICBjb25zdCBpY29uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaScpO1xyXG4gICAgICAgICAgICBpY29uLmNsYXNzTmFtZSA9ICdmYSBmYS1zb3J0IHNvcnQtaWNvbic7XHJcbiAgICAgICAgICAgIGljb24uc3R5bGUubWFyZ2luTGVmdCA9ICc1cHgnO1xyXG4gICAgICAgICAgICBpY29uLnN0eWxlLm9wYWNpdHkgPSAnMC41JztcclxuICAgICAgICAgICAgaWNvbi5zdHlsZS5mb250U2l6ZSA9ICcxMnB4JztcclxuICAgICAgICAgICAgdGguYXBwZW5kQ2hpbGQoaWNvbik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgc29ydFRhYmxlKHRhYmxlU2VsZWN0b3IsIGluZGV4LCB0aCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxufVxyXG5cclxuLyoqXHJcbiAqIE9yZGVuYSBsYSB0YWJsYSBwb3IgbGEgY29sdW1uYSBlc3BlY2lmaWNhZGEuXHJcbiAqL1xyXG5mdW5jdGlvbiBzb3J0VGFibGUodGFibGVTZWxlY3Rvcjogc3RyaW5nLCBjb2x1bW5JbmRleDogbnVtYmVyLCBoZWFkZXJDZWxsOiBIVE1MRWxlbWVudCk6IHZvaWQge1xyXG4gICAgY29uc3QgdGFibGUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHRhYmxlU2VsZWN0b3IpIGFzIEhUTUxUYWJsZUVsZW1lbnQ7XHJcbiAgICBpZiAoIXRhYmxlKSByZXR1cm47XHJcblxyXG4gICAgY29uc3QgdGJvZHkgPSB0YWJsZS5xdWVyeVNlbGVjdG9yKCd0Ym9keScpO1xyXG4gICAgaWYgKCF0Ym9keSkgcmV0dXJuO1xyXG5cclxuICAgIC8vIE9idGVuZXIgZXN0YWRvIGFjdHVhbFxyXG4gICAgY29uc3QgY3VycmVudFN0YXRlID0gc29ydFN0YXRlLmdldCh0YWJsZVNlbGVjdG9yKTtcclxuICAgIGxldCBkaXJlY3Rpb246ICdhc2MnIHwgJ2Rlc2MnID0gJ2FzYyc7XHJcblxyXG4gICAgaWYgKGN1cnJlbnRTdGF0ZSAmJiBjdXJyZW50U3RhdGUuY29sdW1uID09PSBjb2x1bW5JbmRleCkge1xyXG4gICAgICAgIGRpcmVjdGlvbiA9IGN1cnJlbnRTdGF0ZS5kaXJlY3Rpb24gPT09ICdhc2MnID8gJ2Rlc2MnIDogJ2FzYyc7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gR3VhcmRhciBudWV2byBlc3RhZG9cclxuICAgIHNvcnRTdGF0ZS5zZXQodGFibGVTZWxlY3RvciwgeyBjb2x1bW46IGNvbHVtbkluZGV4LCBkaXJlY3Rpb24gfSk7XHJcblxyXG4gICAgLy8gQWN0dWFsaXphciBpY29ub3MgZGUgdG9kb3MgbG9zIGhlYWRlcnNcclxuICAgIGNvbnN0IGFsbEhlYWRlcnMgPSB0YWJsZS5xdWVyeVNlbGVjdG9yQWxsKCd0aGVhZCB0ZDpub3QoLmNoZWNrLWNlbGwtYXBwKScpO1xyXG4gICAgYWxsSGVhZGVycy5mb3JFYWNoKChoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgaWNvbiA9IGgucXVlcnlTZWxlY3RvcignLnNvcnQtaWNvbicpIGFzIEhUTUxFbGVtZW50O1xyXG4gICAgICAgIGlmIChpY29uKSB7XHJcbiAgICAgICAgICAgIGljb24uY2xhc3NOYW1lID0gJ2ZhIGZhLXNvcnQgc29ydC1pY29uJztcclxuICAgICAgICAgICAgaWNvbi5zdHlsZS5vcGFjaXR5ID0gJzAuNSc7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gQWN0dWFsaXphciBpY29ubyBkZWwgaGVhZGVyIGFjdHVhbFxyXG4gICAgY29uc3QgY3VycmVudEljb24gPSBoZWFkZXJDZWxsLnF1ZXJ5U2VsZWN0b3IoJy5zb3J0LWljb24nKSBhcyBIVE1MRWxlbWVudDtcclxuICAgIGlmIChjdXJyZW50SWNvbikge1xyXG4gICAgICAgIGN1cnJlbnRJY29uLmNsYXNzTmFtZSA9IGRpcmVjdGlvbiA9PT0gJ2FzYycgPyAnZmEgZmEtc29ydC1hc2Mgc29ydC1pY29uJyA6ICdmYSBmYS1zb3J0LWRlc2Mgc29ydC1pY29uJztcclxuICAgICAgICBjdXJyZW50SWNvbi5zdHlsZS5vcGFjaXR5ID0gJzEnO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIE9idGVuZXIgZmlsYXMgeSBvcmRlbmFyXHJcbiAgICBjb25zdCByb3dzID0gQXJyYXkuZnJvbSh0Ym9keS5xdWVyeVNlbGVjdG9yQWxsKCd0ci5yb3ctYXBwJykpO1xyXG5cclxuICAgIHJvd3Muc29ydCgoYSwgYikgPT4ge1xyXG4gICAgICAgIC8vICsxIHBvcnF1ZSBsYSBwcmltZXJhIGNlbGRhIGVzIGVsIGNoZWNrYm94XHJcbiAgICAgICAgY29uc3QgY2VsbEEgPSBhLnF1ZXJ5U2VsZWN0b3JBbGwoJ3RkJylbY29sdW1uSW5kZXggKyAxXTtcclxuICAgICAgICBjb25zdCBjZWxsQiA9IGIucXVlcnlTZWxlY3RvckFsbCgndGQnKVtjb2x1bW5JbmRleCArIDFdO1xyXG5cclxuICAgICAgICBpZiAoIWNlbGxBIHx8ICFjZWxsQikgcmV0dXJuIDA7XHJcblxyXG4gICAgICAgIGxldCB2YWx1ZUEgPSAoY2VsbEEudGV4dENvbnRlbnQgfHwgJycpLnRyaW0oKTtcclxuICAgICAgICBsZXQgdmFsdWVCID0gKGNlbGxCLnRleHRDb250ZW50IHx8ICcnKS50cmltKCk7XHJcblxyXG4gICAgICAgIC8vIEludGVudGFyIGNvbXBhcmFyIGNvbW8gbsO6bWVyb3NcclxuICAgICAgICBjb25zdCBudW1BID0gcGFyc2VGbG9hdCh2YWx1ZUEucmVwbGFjZSgvW14wLTkuLV0vZywgJycpKTtcclxuICAgICAgICBjb25zdCBudW1CID0gcGFyc2VGbG9hdCh2YWx1ZUIucmVwbGFjZSgvW14wLTkuLV0vZywgJycpKTtcclxuXHJcbiAgICAgICAgaWYgKCFpc05hTihudW1BKSAmJiAhaXNOYU4obnVtQikpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGRpcmVjdGlvbiA9PT0gJ2FzYycgPyBudW1BIC0gbnVtQiA6IG51bUIgLSBudW1BO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gSW50ZW50YXIgY29tcGFyYXIgY29tbyBmZWNoYXMgKGZvcm1hdG8gZGQvbW0veXl5eSBvIHNpbWlsYXIpXHJcbiAgICAgICAgY29uc3QgZGF0ZUEgPSBwYXJzZURhdGUodmFsdWVBKTtcclxuICAgICAgICBjb25zdCBkYXRlQiA9IHBhcnNlRGF0ZSh2YWx1ZUIpO1xyXG5cclxuICAgICAgICBpZiAoZGF0ZUEgJiYgZGF0ZUIpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGRpcmVjdGlvbiA9PT0gJ2FzYydcclxuICAgICAgICAgICAgICAgID8gZGF0ZUEuZ2V0VGltZSgpIC0gZGF0ZUIuZ2V0VGltZSgpXHJcbiAgICAgICAgICAgICAgICA6IGRhdGVCLmdldFRpbWUoKSAtIGRhdGVBLmdldFRpbWUoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIENvbXBhcmFyIGNvbW8gdGV4dG9cclxuICAgICAgICB2YWx1ZUEgPSB2YWx1ZUEudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICB2YWx1ZUIgPSB2YWx1ZUIudG9Mb3dlckNhc2UoKTtcclxuXHJcbiAgICAgICAgaWYgKGRpcmVjdGlvbiA9PT0gJ2FzYycpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHZhbHVlQS5sb2NhbGVDb21wYXJlKHZhbHVlQiwgJ2VzJyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIHZhbHVlQi5sb2NhbGVDb21wYXJlKHZhbHVlQSwgJ2VzJyk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gUmVpbnNlcnRhciBmaWxhcyBvcmRlbmFkYXNcclxuICAgIHJvd3MuZm9yRWFjaCgocm93KSA9PiB0Ym9keS5hcHBlbmRDaGlsZChyb3cpKTtcclxufVxyXG5cclxuLyoqXHJcbiAqIEludGVudGEgcGFyc2VhciB1bmEgZmVjaGEgZW4gdmFyaW9zIGZvcm1hdG9zIGNvbXVuZXMuXHJcbiAqL1xyXG5mdW5jdGlvbiBwYXJzZURhdGUoZGF0ZVN0cjogc3RyaW5nKTogRGF0ZSB8IG51bGwge1xyXG4gICAgaWYgKCFkYXRlU3RyKSByZXR1cm4gbnVsbDtcclxuXHJcbiAgICAvLyBGb3JtYXRvIGRkL21tL3l5eXlcclxuICAgIGNvbnN0IHBhcnRzMSA9IGRhdGVTdHIubWF0Y2goL14oXFxkezEsMn0pXFwvKFxcZHsxLDJ9KVxcLyhcXGR7NH0pJC8pO1xyXG4gICAgaWYgKHBhcnRzMSkge1xyXG4gICAgICAgIHJldHVybiBuZXcgRGF0ZShwYXJzZUludChwYXJ0czFbM10pLCBwYXJzZUludChwYXJ0czFbMl0pIC0gMSwgcGFyc2VJbnQocGFydHMxWzFdKSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gRm9ybWF0byBtbS9kZC95eXl5XHJcbiAgICBjb25zdCBwYXJ0czIgPSBkYXRlU3RyLm1hdGNoKC9eKFxcZHsxLDJ9KVxcLyhcXGR7MSwyfSlcXC8oXFxkezR9KSQvKTtcclxuICAgIGlmIChwYXJ0czIpIHtcclxuICAgICAgICBjb25zdCBkYXRlID0gbmV3IERhdGUocGFyc2VJbnQocGFydHMyWzNdKSwgcGFyc2VJbnQocGFydHMyWzFdKSAtIDEsIHBhcnNlSW50KHBhcnRzMlsyXSkpO1xyXG4gICAgICAgIGlmICghaXNOYU4oZGF0ZS5nZXRUaW1lKCkpKSByZXR1cm4gZGF0ZTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBGb3JtYXRvIHl5eXktbW0tZGRcclxuICAgIGNvbnN0IHBhcnRzMyA9IGRhdGVTdHIubWF0Y2goL14oXFxkezR9KS0oXFxkezJ9KS0oXFxkezJ9KSQvKTtcclxuICAgIGlmIChwYXJ0czMpIHtcclxuICAgICAgICByZXR1cm4gbmV3IERhdGUocGFyc2VJbnQocGFydHMzWzFdKSwgcGFyc2VJbnQocGFydHMzWzJdKSAtIDEsIHBhcnNlSW50KHBhcnRzM1szXSkpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBudWxsO1xyXG59XHJcblxyXG4vKipcclxuICogSW5pY2lhbGl6YSB0b2RhcyBsYXMgZnVuY2lvbmFsaWRhZGVzIGRlIHRhYmxhLlxyXG4gKiBAcGFyYW0gY29uZmlnIENvbmZpZ3VyYWNpw7NuIGRlIGxhIHRhYmxhIG8gc2VsZWN0b3IgZGUgbGEgdGFibGFcclxuICovXHJcbmZ1bmN0aW9uIGluaXRUYWJsZUZlYXR1cmVzKGNvbmZpZzogc3RyaW5nIHwge1xyXG4gICAgZmlsdGVySW5wdXQ6IHN0cmluZztcclxuICAgIHRhYmxlOiBzdHJpbmc7XHJcbiAgICB0Ym9keTogc3RyaW5nO1xyXG59KTogdm9pZCB7XHJcbiAgICAvLyBTaSBlcyB1biBzdHJpbmcsIGNyZWFyIGNvbmZpZ3VyYWNpw7NuIGF1dG9tw6F0aWNhXHJcbiAgICBsZXQgdGFibGVTZWxlY3Rvcjogc3RyaW5nO1xyXG4gICAgbGV0IGZpbHRlcklucHV0U2VsZWN0b3I6IHN0cmluZztcclxuICAgIGxldCB0Ym9keVNlbGVjdG9yOiBzdHJpbmc7XHJcblxyXG4gICAgaWYgKHR5cGVvZiBjb25maWcgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgdGFibGVTZWxlY3RvciA9IGNvbmZpZztcclxuICAgICAgICAvLyBCdXNjYXIgZWwgaW5wdXQgZGUgZmlsdHJvIG3DoXMgY29tw7puIChWaWV3RmlsdGVyLmNzaHRtbCB1c2EgLnRleHRGaWx0ZXJNYXNrKVxyXG4gICAgICAgIGZpbHRlcklucHV0U2VsZWN0b3IgPSAnLnRleHRGaWx0ZXJNYXNrLCAuZm9ybS1jb250cm9sLXRleHQtZmlsdHJlLCAuZm9ybS1jb250cm9sLWZpbHRybywgLmZvcm0tY29udHJvbC1GaWx0cm9EZXBhcnRtZW50LCBpbnB1dFtwbGFjZWhvbGRlcio9XCJCdXNjYXJcIl0sIGlucHV0W3BsYWNlaG9sZGVyKj1cImNvbHVtbmFzXCJdJztcclxuICAgICAgICB0Ym9keVNlbGVjdG9yID0gYCR7Y29uZmlnfSB0Ym9keWA7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRhYmxlU2VsZWN0b3IgPSBjb25maWcudGFibGU7XHJcbiAgICAgICAgZmlsdGVySW5wdXRTZWxlY3RvciA9IGNvbmZpZy5maWx0ZXJJbnB1dDtcclxuICAgICAgICB0Ym9keVNlbGVjdG9yID0gY29uZmlnLnRib2R5O1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGRvSW5pdCA9ICgpID0+IHtcclxuICAgICAgICBpbml0VGFibGVGaWx0ZXIoZmlsdGVySW5wdXRTZWxlY3RvciwgdGFibGVTZWxlY3RvciwgdGJvZHlTZWxlY3Rvcik7XHJcbiAgICAgICAgaW5pdFRhYmxlU29ydCh0YWJsZVNlbGVjdG9yKTtcclxuICAgIH07XHJcblxyXG4gICAgLy8gRXNwZXJhciBhIHF1ZSBlbCBET00gZXN0w6kgbGlzdG9cclxuICAgIGlmIChkb2N1bWVudC5yZWFkeVN0YXRlID09PSAnbG9hZGluZycpIHtcclxuICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgZG9Jbml0KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgZG9Jbml0KCk7XHJcbiAgICB9XHJcbn1cclxuXHJcbi8vIEV4cG9ydGFyIGFsIMOhbWJpdG8gZ2xvYmFsXHJcbih3aW5kb3cgYXMgYW55KS5pbml0VGFibGVGZWF0dXJlcyA9IGluaXRUYWJsZUZlYXR1cmVzO1xyXG4od2luZG93IGFzIGFueSkuaW5pdFRhYmxlRmlsdGVyID0gaW5pdFRhYmxlRmlsdGVyO1xyXG4od2luZG93IGFzIGFueSkuaW5pdFRhYmxlU29ydCA9IGluaXRUYWJsZVNvcnQ7XHJcbiJdfQ==
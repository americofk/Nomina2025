/**
 * @file AuditLog.ts
 * @description Módulo de gestión de registros de auditoría ISO 27001.
 *              Solo permite visualización de cambios en entidades del sistema.
 * @author Equipo de Desarrollo
 * @date 2025
 * @module Auditoria
 */
// Seleccionar/deseleccionar todos los checkboxes
$(document).on('change', '#selectAllAuditLog', function () {
    var isChecked = $(this).is(':checked');
    $('.selectAuditLog').prop('checked', isChecked);
});
// Ver detalles del registro seleccionado
$(document).on('click', '.ViewAuditLogDetails', function () {
    showAuditLogDetails();
});
// Función para mostrar detalles de auditoría
function showAuditLogDetails() {
    var recId = 0;
    var contador = 0;
    $(".selectAuditLog[type=checkbox]").each(function () {
        if ($(this).is(":checked")) {
            contador++;
            recId = parseInt($(this).parent().parent().find(".AuditLogRecIdtbl").html().trim());
        }
    });
    if (contador === 0) {
        windows_message("Debe seleccionar un registro para ver los detalles", "error");
        return;
    }
    if (contador > 1) {
        windows_message("Debe seleccionar solo un registro", "info");
        return;
    }
    // Obtener los datos del registro
    $.ajax({
        url: "/auditoria/getbyid",
        type: "GET",
        data: { RecId: recId },
        async: true,
        success: function (data) {
            if (data != null) {
                populateAuditLogModal(data);
                $('.modal-AuditLogDetails').modal('show');
            }
            else {
                windows_message("Error obteniendo datos del registro", "error");
            }
        },
        error: function (xhr) {
            redireccionaralLogin(xhr);
        }
    });
}
// Llenar el modal con los datos
function populateAuditLogModal(data) {
    var _a, _b;
    // Soportar tanto camelCase como PascalCase
    $('#audit-detail-recid').val(((_a = (data.recId || data.RecId)) === null || _a === void 0 ? void 0 : _a.toString()) || '');
    $('#audit-detail-dataareaid').val(data.dataAreaId || data.DataAreaId || '');
    $('#audit-detail-entityname').val(data.entityName || data.EntityName || '');
    $('#audit-detail-fieldname').val(data.fieldName || data.FieldName || '');
    $('#audit-detail-changedby').val(data.changedBy || data.ChangedBy || '');
    $('#audit-detail-changedat').val(formatDateTime(data.changedAt || data.ChangedAt));
    $('#audit-detail-entityrefrecid').val(((_b = (data.entityRefRecId || data.EntityRefRecId)) === null || _b === void 0 ? void 0 : _b.toString()) || '');
    $('#audit-detail-oldvalue').val(data.oldValue || data.OldValue || '');
    $('#audit-detail-newvalue').val(data.newValue || data.NewValue || '');
}
// Formatear fecha y hora
function formatDateTime(dateString) {
    if (!dateString)
        return '';
    var date = new Date(dateString);
    var day = date.getDate() < 10 ? '0' + date.getDate() : String(date.getDate());
    var month = (date.getMonth() + 1) < 10 ? '0' + (date.getMonth() + 1) : String(date.getMonth() + 1);
    var year = date.getFullYear();
    var hours = date.getHours() < 10 ? '0' + date.getHours() : String(date.getHours());
    var minutes = date.getMinutes() < 10 ? '0' + date.getMinutes() : String(date.getMinutes());
    var seconds = date.getSeconds() < 10 ? '0' + date.getSeconds() : String(date.getSeconds());
    return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
}
// Cerrar modal de detalles
$(document).on('click', '.close-modal-auditlog-details', function () {
    $('.modal-AuditLogDetails').modal('hide');
});
// Doble clic en fila para ver detalles
$(document).on('dblclick', '.tbody-Table-AuditLog .row-app', function () {
    // Desmarcar todos los checkboxes
    $('.selectAuditLog').prop('checked', false);
    // Marcar el checkbox de la fila actual
    $(this).find('.selectAuditLog').prop('checked', true);
    // Mostrar detalles
    showAuditLogDetails();
});
// Filtro de datos
$(document).on('change', '#auditlog-page .optionFilter', function () {
    optionFilterFunction(this);
    if ($('.textFilter').val() != "") {
        Datafilter(".tbody-Table-AuditLog", "/auditoria/FilterOrMoreData");
    }
});
$(document).on('keyup', '#auditlog-page .textFilterMask', function (e) {
    var keycode = e.keyCode || e.which;
    if (keycode == 13) {
        textFilterMaskFunction(this);
        Datafilter(".tbody-Table-AuditLog", "/auditoria/FilterOrMoreData");
    }
});
// Scroll infinito para paginación
$(document).on('scroll', '#auditlog-page #content-scroll', function () {
    let currentscroll = $("#content-scroll").scrollTop();
    let maxscroll = $(".tblAuditLog").outerHeight(true) - $("#content-scroll").outerHeight(true);
    if (currentscroll == Math.round(maxscroll)) {
        if (!isBusy) {
            moredata(maxscroll, "auditoria", ".tbody-Table-AuditLog");
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXVkaXRMb2cuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9UeXBlU2NyaXB0RmlsZS9BdWRpdExvZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztHQU9HO0FBbUJILGlEQUFpRDtBQUNqRCxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxDQUFDLFFBQVEsRUFBRSxvQkFBb0IsRUFBRTtJQUMzQyxJQUFJLFNBQVMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ3ZDLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsU0FBUyxDQUFDLENBQUM7QUFDcEQsQ0FBQyxDQUFDLENBQUM7QUFFSCx5Q0FBeUM7QUFDekMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsc0JBQXNCLEVBQUU7SUFDNUMsbUJBQW1CLEVBQUUsQ0FBQztBQUMxQixDQUFDLENBQUMsQ0FBQztBQUVILDZDQUE2QztBQUM3QyxTQUFTLG1CQUFtQjtJQUN4QixJQUFJLEtBQUssR0FBVyxDQUFDLENBQUM7SUFDdEIsSUFBSSxRQUFRLEdBQUcsQ0FBQyxDQUFDO0lBRWpCLENBQUMsQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDLElBQUksQ0FBQztRQUNyQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQztZQUN6QixRQUFRLEVBQUUsQ0FBQztZQUNYLEtBQUssR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7UUFDeEYsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxRQUFR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QVUsQ0FBQyxDQUFDO0lBQ2hDLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztJQUM5RSxJQUFJLEtBQUssR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUNuRyxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDOUIsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO0lBQ25GLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxVQUFVLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQztJQUMzRixJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsVUFBVSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUM7SUFDM0YsT0FBTyxHQUFHLEdBQUcsSUFBSSxLQUFLLElBQUksSUFBSSxJQUFJLEtBQUssSUFBSSxPQUFPLElBQUksT0FBTyxFQUFFLENBQUM7QUFDcEUsQ0FBQztBQUVELDJCQUEyQjtBQUMzQixDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSwrQkFBK0IsRUFBRTtJQUNyRCxDQUFDLENBQUMsd0JBQXdCLENBQUMsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDOUMsQ0FBQyxDQUFDLENBQUM7QUFFSCx1Q0FBdUM7QUFDdkMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxVQUFVLEVBQUUsZ0NBQWdDLEVBQUU7SUFDekQsaUNBQWlDO0lBQ2pDLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDNUMsdUNBQXVDO0lBQ3ZDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3RELG1CQUFtQjtJQUNuQixtQkFBbUIsRUFBRSxDQUFDO0FBQzFCLENBQUMsQ0FBQyxDQUFDO0FBRUgsa0JBQWtCO0FBQ2xCLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLENBQUMsUUFBUSxFQUFFLDhCQUE4QixFQUFFO0lBQ3JELG9CQUFvQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBRTNCLElBQUksQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsRUFBRSxDQUFDO1FBQy9CLFVBQVUsQ0FBQyx1QkFBdUIsRUFBRSw2QkFBNkIsQ0FBQyxDQUFDO0lBQ3ZFLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQztBQUVILENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLGdDQUFnQyxFQUFFLFVBQVUsQ0FBQztJQUNqRSxJQUFJLE9BQU8sR0FBSSxDQUFTLENBQUMsT0FBTyxJQUFLLENBQVMsQ0FBQyxLQUFLLENBQUM7SUFDckQsSUFBSSxPQUFPLElBQUksRUFBRSxFQUFFLENBQUM7UUFDaEIsc0JBQXNCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDN0IsVUFBVSxDQUFDLHVCQUF1QixFQUFFLDZCQUE2QixDQUFDLENBQUM7SUFDdkUsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDO0FBRUgsa0NBQWtDO0FBQ2xDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLENBQUMsUUFBUSxFQUFFLGdDQUFnQyxFQUFFO0lBQ3ZELElBQUksYUFBYSxHQUFHLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLFNBQVMsRUFBRSxDQUFDO0lBQ3JELElBQUksU0FBUyxHQUFHLENBQUMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLGlCQUFpQixDQUFDLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRTdGLElBQUksYUFBYSxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQztRQUN6QyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDVixRQUFRLENBQUMsU0FBUyxFQUFFLFdBQVcsRUFBRSx1QkFBdUIsQ0FBQyxDQUFDO1FBQzlELENBQUM7SUFDTCxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogQGZpbGUgQXVkaXRMb2cudHNcclxuICogQGRlc2NyaXB0aW9uIE3Ds2R1bG8gZGUgZ2VzdGnDs24gZGUgcmVnaXN0cm9zIGRlIGF1ZGl0b3LDrWEgSVNPIDI3MDAxLlxyXG4gKiAgICAgICAgICAgICAgU29sbyBwZXJtaXRlIHZpc3VhbGl6YWNpw7NuIGRlIGNhbWJpb3MgZW4gZW50aWRhZGVzIGRlbCBzaXN0ZW1hLlxyXG4gKiBAYXV0aG9yIEVxdWlwbyBkZSBEZXNhcnJvbGxvXHJcbiAqIEBkYXRlIDIwMjVcclxuICogQG1vZHVsZSBBdWRpdG9yaWFcclxuICovXHJcblxyXG4vLyBJbnRlcmZhY2UgcGFyYSBlbCByZWdpc3RybyBkZSBhdWRpdG9yw61hXHJcbmludGVyZmFjZSBJQXVkaXRMb2cge1xyXG4gICAgcmVjSWQ6IG51bWJlcjtcclxuICAgIGRhdGFBcmVhSWQ6IHN0cmluZztcclxuICAgIGNyZWF0ZWRCeTogc3RyaW5nO1xyXG4gICAgY3JlYXRlZE9uOiBzdHJpbmc7XHJcbiAgICBtb2RpZmllZEJ5OiBzdHJpbmc7XHJcbiAgICBtb2RpZmllZE9uOiBzdHJpbmc7XHJcbiAgICBlbnRpdHlOYW1lOiBzdHJpbmc7XHJcbiAgICBmaWVsZE5hbWU6IHN0cmluZztcclxuICAgIG9sZFZhbHVlOiBzdHJpbmc7XHJcbiAgICBuZXdWYWx1ZTogc3RyaW5nO1xyXG4gICAgY2hhbmdlZEJ5OiBzdHJpbmc7XHJcbiAgICBjaGFuZ2VkQXQ6IHN0cmluZztcclxuICAgIGVudGl0eVJlZlJlY0lkOiBudW1iZXI7XHJcbn1cclxuXHJcbi8vIFNlbGVjY2lvbmFyL2Rlc2VsZWNjaW9uYXIgdG9kb3MgbG9zIGNoZWNrYm94ZXNcclxuJChkb2N1bWVudCkub24oJ2NoYW5nZScsICcjc2VsZWN0QWxsQXVkaXRMb2cnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgaXNDaGVja2VkID0gJCh0aGlzKS5pcygnOmNoZWNrZWQnKTtcclxuICAgICQoJy5zZWxlY3RBdWRpdExvZycpLnByb3AoJ2NoZWNrZWQnLCBpc0NoZWNrZWQpO1xyXG59KTtcclxuXHJcbi8vIFZlciBkZXRhbGxlcyBkZWwgcmVnaXN0cm8gc2VsZWNjaW9uYWRvXHJcbiQoZG9jdW1lbnQpLm9uKCdjbGljaycsICcuVmlld0F1ZGl0TG9nRGV0YWlscycsIGZ1bmN0aW9uICgpIHtcclxuICAgIHNob3dBdWRpdExvZ0RldGFpbHMoKTtcclxufSk7XHJcblxyXG4vLyBGdW5jacOzbiBwYXJhIG1vc3RyYXIgZGV0YWxsZXMgZGUgYXVkaXRvcsOtYVxyXG5mdW5jdGlvbiBzaG93QXVkaXRMb2dEZXRhaWxzKCkge1xyXG4gICAgdmFyIHJlY0lkOiBudW1iZXIgPSAwO1xyXG4gICAgdmFyIGNvbnRhZG9yID0gMDtcclxuXHJcbiAgICAkKFwiLnNlbGVjdEF1ZGl0TG9nW3R5cGU9Y2hlY2tib3hdXCIpLmVhY2goZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGlmICgkKHRoaXMpLmlzKFwiOmNoZWNrZWRcIikpIHtcclxuICAgICAgICAgICAgY29udGFkb3IrKztcclxuICAgICAgICAgICAgcmVjSWQgPSBwYXJzZUludCgkKHRoaXMpLnBhcmVudCgpLnBhcmVudCgpLmZpbmQoXCIuQXVkaXRMb2dSZWNJZHRibFwiKS5odG1sKCkudHJpbSgpKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBpZiAoY29udGFkb3IgPT09IDApIHtcclxuICAgICAgICB3aW5kb3dzX21lc3NhZ2UoXCJEZWJlIHNlbGVjY2lvbmFyIHVuIHJlZ2lzdHJvIHBhcmEgdmVyIGxvcyBkZXRhbGxlc1wiLCBcImVycm9yXCIpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoY29udGFkb3IgPiAxKSB7XHJcbiAgICAgICAgd2luZG93c19tZXNzYWdlKFwiRGViZSBzZWxlY2Npb25hciBzb2xvIHVuIHJlZ2lzdHJvXCIsIFwiaW5mb1wiKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgLy8gT2J0ZW5lciBsb3MgZGF0b3MgZGVsIHJlZ2lzdHJvXHJcbiAgICAkLmFqYXgoe1xyXG4gICAgICAgIHVybDogXCIvYXVkaXRvcmlhL2dldGJ5aWRcIixcclxuICAgICAgICB0eXBlOiBcIkdFVFwiLFxyXG4gICAgICAgIGRhdGE6IHsgUmVjSWQ6IHJlY0lkIH0sXHJcbiAgICAgICAgYXN5bmM6IHRydWUsXHJcbiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGE6IElBdWRpdExvZykge1xyXG4gICAgICAgICAgICBpZiAoZGF0YSAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICBwb3B1bGF0ZUF1ZGl0TG9nTW9kYWwoZGF0YSk7XHJcbiAgICAgICAgICAgICAgICAkKCcubW9kYWwtQXVkaXRMb2dEZXRhaWxzJykubW9kYWwoJ3Nob3cnKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHdpbmRvd3NfbWVzc2FnZShcIkVycm9yIG9idGVuaWVuZG8gZGF0b3MgZGVsIHJlZ2lzdHJvXCIsIFwiZXJyb3JcIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIGVycm9yOiBmdW5jdGlvbiAoeGhyKSB7XHJcbiAgICAgICAgICAgIHJlZGlyZWNjaW9uYXJhbExvZ2luKHhocik7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn1cclxuXHJcbi8vIExsZW5hciBlbCBtb2RhbCBjb24gbG9zIGRhdG9zXHJcbmZ1bmN0aW9uIHBvcHVsYXRlQXVkaXRMb2dNb2RhbChkYXRhOiBhbnkpIHtcclxuICAgIC8vIFNvcG9ydGFyIHRhbnRvIGNhbWVsQ2FzZSBjb21vIFBhc2NhbENhc2VcclxuICAgICQoJyNhdWRpdC1kZXRhaWwtcmVjaWQnKS52YWwoKGRhdGEucmVjSWQgfHwgZGF0YS5SZWNJZCk/LnRvU3RyaW5nKCkgfHwgJycpO1xyXG4gICAgJCgnI2F1ZGl0LWRldGFpbC1kYXRhYXJlYWlkJykudmFsKGRhdGEuZGF0YUFyZWFJZCB8fCBkYXRhLkRhdGFBcmVhSWQgfHwgJycpO1xyXG4gICAgJCgnI2F1ZGl0LWRldGFpbC1lbnRpdHluYW1lJykudmFsKGRhdGEuZW50aXR5TmFtZSB8fCBkYXRhLkVudGl0eU5hbWUgfHwgJycpO1xyXG4gICAgJCgnI2F1ZGl0LWRldGFpbC1maWVsZG5hbWUnKS52YWwoZGF0YS5maWVsZE5hbWUgfHwgZGF0YS5GaWVsZE5hbWUgfHwgJycpO1xyXG4gICAgJCgnI2F1ZGl0LWRldGFpbC1jaGFuZ2VkYnknKS52YWwoZGF0YS5jaGFuZ2VkQnkgfHwgZGF0YS5DaGFuZ2VkQnkgfHwgJycpO1xyXG4gICAgJCgnI2F1ZGl0LWRldGFpbC1jaGFuZ2VkYXQnKS52YWwoZm9ybWF0RGF0ZVRpbWUoZGF0YS5jaGFuZ2VkQXQgfHwgZGF0YS5DaGFuZ2VkQXQpKTtcclxuICAgICQoJyNhdWRpdC1kZXRhaWwtZW50aXR5cmVmcmVjaWQnKS52YWwoKGRhdGEuZW50aXR5UmVmUmVjSWQgfHwgZGF0YS5FbnRpdHlSZWZSZWNJZCk/LnRvU3RyaW5nKCkgfHwgJycpO1xyXG4gICAgJCgnI2F1ZGl0LWRldGFpbC1vbGR2YWx1ZScpLnZhbChkYXRhLm9sZFZhbHVlIHx8IGRhdGEuT2xkVmFsdWUgfHwgJycpO1xyXG4gICAgJCgnI2F1ZGl0LWRldGFpbC1uZXd2YWx1ZScpLnZhbChkYXRhLm5ld1ZhbHVlIHx8IGRhdGEuTmV3VmFsdWUgfHwgJycpO1xyXG59XHJcblxyXG4vLyBGb3JtYXRlYXIgZmVjaGEgeSBob3JhXHJcbmZ1bmN0aW9uIGZvcm1hdERhdGVUaW1lKGRhdGVTdHJpbmc6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICBpZiAoIWRhdGVTdHJpbmcpIHJldHVybiAnJztcclxuICAgIHZhciBkYXRlID0gbmV3IERhdGUoZGF0ZVN0cmluZyk7XHJcbiAgICB2YXIgZGF5ID0gZGF0ZS5nZXREYXRlKCkgPCAxMCA/ICcwJyArIGRhdGUuZ2V0RGF0ZSgpIDogU3RyaW5nKGRhdGUuZ2V0RGF0ZSgpKTtcclxuICAgIHZhciBtb250aCA9IChkYXRlLmdldE1vbnRoKCkgKyAxKSA8IDEwID8gJzAnICsgKGRhdGUuZ2V0TW9udGgoKSArIDEpIDogU3RyaW5nKGRhdGUuZ2V0TW9udGgoKSArIDEpO1xyXG4gICAgdmFyIHllYXIgPSBkYXRlLmdldEZ1bGxZZWFyKCk7XHJcbiAgICB2YXIgaG91cnMgPSBkYXRlLmdldEhvdXJzKCkgPCAxMCA/ICcwJyArIGRhdGUuZ2V0SG91cnMoKSA6IFN0cmluZyhkYXRlLmdldEhvdXJzKCkpO1xyXG4gICAgdmFyIG1pbnV0ZXMgPSBkYXRlLmdldE1pbnV0ZXMoKSA8IDEwID8gJzAnICsgZGF0ZS5nZXRNaW51dGVzKCkgOiBTdHJpbmcoZGF0ZS5nZXRNaW51dGVzKCkpO1xyXG4gICAgdmFyIHNlY29uZHMgPSBkYXRlLmdldFNlY29uZHMoKSA8IDEwID8gJzAnICsgZGF0ZS5nZXRTZWNvbmRzKCkgOiBTdHJpbmcoZGF0ZS5nZXRTZWNvbmRzKCkpO1xyXG4gICAgcmV0dXJuIGAke2RheX0vJHttb250aH0vJHt5ZWFyfSAke2hvdXJzfToke21pbnV0ZXN9OiR7c2Vjb25kc31gO1xyXG59XHJcblxyXG4vLyBDZXJyYXIgbW9kYWwgZGUgZGV0YWxsZXNcclxuJChkb2N1bWVudCkub24oJ2NsaWNrJywgJy5jbG9zZS1tb2RhbC1hdWRpdGxvZy1kZXRhaWxzJywgZnVuY3Rpb24gKCkge1xyXG4gICAgJCgnLm1vZGFsLUF1ZGl0TG9nRGV0YWlscycpLm1vZGFsKCdoaWRlJyk7XHJcbn0pO1xyXG5cclxuLy8gRG9ibGUgY2xpYyBlbiBmaWxhIHBhcmEgdmVyIGRldGFsbGVzXHJcbiQoZG9jdW1lbnQpLm9uKCdkYmxjbGljaycsICcudGJvZHktVGFibGUtQXVkaXRMb2cgLnJvdy1hcHAnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAvLyBEZXNtYXJjYXIgdG9kb3MgbG9zIGNoZWNrYm94ZXNcclxuICAgICQoJy5zZWxlY3RBdWRpdExvZycpLnByb3AoJ2NoZWNrZWQnLCBmYWxzZSk7XHJcbiAgICAvLyBNYXJjYXIgZWwgY2hlY2tib3ggZGUgbGEgZmlsYSBhY3R1YWxcclxuICAgICQodGhpcykuZmluZCgnLnNlbGVjdEF1ZGl0TG9nJykucHJvcCgnY2hlY2tlZCcsIHRydWUpO1xyXG4gICAgLy8gTW9zdHJhciBkZXRhbGxlc1xyXG4gICAgc2hvd0F1ZGl0TG9nRGV0YWlscygpO1xyXG59KTtcclxuXHJcbi8vIEZpbHRybyBkZSBkYXRvc1xyXG4kKGRvY3VtZW50KS5vbignY2hhbmdlJywgJyNhdWRpdGxvZy1wYWdlIC5vcHRpb25GaWx0ZXInLCBmdW5jdGlvbiAoKSB7XHJcbiAgICBvcHRpb25GaWx0ZXJGdW5jdGlvbih0aGlzKTtcclxuXHJcbiAgICBpZiAoJCgnLnRleHRGaWx0ZXInKS52YWwoKSAhPSBcIlwiKSB7XHJcbiAgICAgICAgRGF0YWZpbHRlcihcIi50Ym9keS1UYWJsZS1BdWRpdExvZ1wiLCBcIi9hdWRpdG9yaWEvRmlsdGVyT3JNb3JlRGF0YVwiKTtcclxuICAgIH1cclxufSk7XHJcblxyXG4kKGRvY3VtZW50KS5vbigna2V5dXAnLCAnI2F1ZGl0bG9nLXBhZ2UgLnRleHRGaWx0ZXJNYXNrJywgZnVuY3Rpb24gKGUpIHtcclxuICAgIHZhciBrZXljb2RlID0gKGUgYXMgYW55KS5rZXlDb2RlIHx8IChlIGFzIGFueSkud2hpY2g7XHJcbiAgICBpZiAoa2V5Y29kZSA9PSAxMykge1xyXG4gICAgICAgIHRleHRGaWx0ZXJNYXNrRnVuY3Rpb24odGhpcyk7XHJcbiAgICAgICAgRGF0YWZpbHRlcihcIi50Ym9keS1UYWJsZS1BdWRpdExvZ1wiLCBcIi9hdWRpdG9yaWEvRmlsdGVyT3JNb3JlRGF0YVwiKTtcclxuICAgIH1cclxufSk7XHJcblxyXG4vLyBTY3JvbGwgaW5maW5pdG8gcGFyYSBwYWdpbmFjacOzblxyXG4kKGRvY3VtZW50KS5vbignc2Nyb2xsJywgJyNhdWRpdGxvZy1wYWdlICNjb250ZW50LXNjcm9sbCcsIGZ1bmN0aW9uICgpIHtcclxuICAgIGxldCBjdXJyZW50c2Nyb2xsID0gJChcIiNjb250ZW50LXNjcm9sbFwiKS5zY3JvbGxUb3AoKTtcclxuICAgIGxldCBtYXhzY3JvbGwgPSAkKFwiLnRibEF1ZGl0TG9nXCIpLm91dGVySGVpZ2h0KHRydWUpIC0gJChcIiNjb250ZW50LXNjcm9sbFwiKS5vdXRlckhlaWdodCh0cnVlKTtcclxuXHJcbiAgICBpZiAoY3VycmVudHNjcm9sbCA9PSBNYXRoLnJvdW5kKG1heHNjcm9sbCkpIHtcclxuICAgICAgICBpZiAoIWlzQnVzeSkge1xyXG4gICAgICAgICAgICBtb3JlZGF0YShtYXhzY3JvbGwsIFwiYXVkaXRvcmlhXCIsIFwiLnRib2R5LVRhYmxlLUF1ZGl0TG9nXCIpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufSk7XHJcbiJdfQ==